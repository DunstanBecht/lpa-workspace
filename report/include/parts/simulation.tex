\section{Simulation}

\subsection{Principle}

This section introduces the main aspects of the X-ray diffraction theory and how it is numerically simulated here.

\subsubsection{The diffracted intensity profile and its Fourier transform}

Let \gls{difint} be the \glsdesc{difint} as defined by \textcite{W1979}.
\gls{difint} is a function of \gls{radcdn} the \glsdesc{radcdn} defined in \eqref{eq:S}.
\gls{wavlen} is the \glsdesc{wavlen}, \( \gls{brgang}_B \) is the Bragg angle of the average lattice defined in \eqref{eq:Bragg-angle} and \gls{celprm} is the \glsdesc{celprm}.
\gls{difint} is normalized according to \eqref{eq:norm-I}.

\begin{equation}\label{eq:Bragg-angle}
\sin \gls{brgang}_B = \frac{\gls{wavlen} \sqrt{h^2+k^2+l^2}}{2 \gls{celprm}}
\end{equation}

\begin{equation}\label{eq:S}
\gls{radcdn} = \frac{2 \left( \sin \gls{brgang} - \sin \gls{brgang}_B \right)}{\gls{wavlen}}
\end{equation}

\begin{equation}\label{eq:norm-I}
\int \gls{difint}(\gls{radcdn}) d\gls{radcdn} = 1
\end{equation}

The \glsdesc{difint} \gls{difint} can be represented in terms of its Fourier transform coefficients \gls{frrcfa} and \gls{frrcfb} for \( {\gls{hmc}} \in \gls{setN}^*_+ \) according to \eqref{eq:fourier-a} and \eqref{eq:fourier-b}.

\begin{equation}\label{eq:fourier-a}
\gls{frrcfa}(\gls{frrvar}) = \int \gls{difint}(\gls{radcdn}) \cos \left( -2 \pi \gls{hmc} \gls{radcdn} \gls{frrvar} \right) d\gls{radcdn}
\end{equation}

\begin{equation}\label{eq:fourier-b}
\gls{frrcfb}(\gls{frrvar}) = \int \gls{difint}(\gls{radcdn}) \sin \left( -2 \pi \gls{hmc} \gls{radcdn} \gls{frrvar} \right) d\gls{radcdn}
\end{equation}

Let \gls{vecu} be the \glsdesc{vecu}.
According to the kinematical theory of X-ray scattering \cite{W1990}:

\begin{equation}\label{eq:fourier-a-warren}
\gls{frrcfa}(\gls{frrvar}) = \frac{\int_{\gls{roi}} \cos \left( 2 \pi \gls{hmc} \gls{vecg} \cdot \left[ \gls{vecu}(\vec{r} + \gls{frrvar} \overrightarrow{u_x}) - \gls{vecu}(\vec{r}) \right] \right) d\vec{r}}{\gls{area}_{\gls{roi}}}
\end{equation}

\begin{equation}\label{eq:fourier-b-warren}
\gls{frrcfb}(\gls{frrvar}) = \frac{\int_{\gls{roi}} \sin \left( 2 \pi \gls{hmc} \gls{vecg} \cdot \left[ \gls{vecu}(\vec{r} + \gls{frrvar} \overrightarrow{u_x}) - \gls{vecu}(\vec{r}) \right] \right) d\vec{r}}{\gls{area}_{\gls{roi}}}
\end{equation}

\medskip

The resultant displacement field created by a dislocation located in \( ( x, y ) \) with respect to the observation position is given in equation \eqref{eq:displacement-field}.

\begin{align}\label{eq:displacement-field}
\gls{vecu} =
  \left( \begin{array}{l}
    \gls{indfun}_{\mathrm{edge}} \frac{| \gls{vecb} |}{2 \pi} \left( \arctan \left( \frac{y}{x} \right) + \frac{x y}{2 (1 - \gls{pssrat}) \left( x^2 + y^2 \right)} \right)
    \\[5mm]
    - \gls{indfun}_{\mathrm{edge}} \frac{| \gls{vecb} |}{8 \pi (1 - \gls{pssrat})} \left( (1 - 2 \gls{pssrat}) \ln \left( x^2 + y^2 \right) + \frac{x^2 - y^2}{x^2 + y^2} \right)
    \\[5mm]
    \gls{indfun}_{\mathrm{screw}} \frac{| \gls{vecb} |}{2 \pi} \arctan \left( \frac{y}{x} \right)
  \end{array} \right)
\end{align}

\subsubsection{Parallelization}

To calculate \( \gls{frrcfa}(\gls{frrvar}) \) and \( \gls{frrcfb}(\gls{frrvar}) \), the Monte Carlo method is used.
A large number of random points \( \vec{r} \) are drawn in the crystal and the equations \eqref{eq:fourier-a-warren} and \eqref{eq:fourier-b-warren} are applied. The random draws and the calculations are then parallelized since they are independent.

\subsection{Parameters choice}

Many parameters related to the Monte-Carlo approach and simulation choices have to be defined.
There is not always an explicit method for selecting them.
This section aims to present the criteria used and evaluated to determine their values.

\subsubsection{Step}

The step for \gls{frrvar} is called \gls{frrstp} and is given in equation \eqref{eq:fourier-a3} \cite{W1990}.
There are experimental constraints on \gls{brgang} that limit the range of available values for \gls{frrstp}.
The minimum value of \gls{frrstp} is determined by the maximum value of \( | \gls{brgang} - \gls{brgang}_B | = \Delta \gls{brgang} / 2 \).
And the maximum value of \gls{frrstp} is determined by the minimum value of \( \Delta \gls{brgang} / 2 \).
The minimum value of \( \Delta \gls{brgang} / 2 \) is related to the proximity of neighboring peaks (centered on the contiguous Bragg angles).
Several peaks should not overlap in the angular area under study.
We will fix here the upper limit of \( \Delta \gls{brgang} / 2 \) at half the angular distance of the closest Bragg angle.
The minimum value of \( \Delta \gls{brgang} / 2 \) is arbitrary and without much importance.

\begin{equation}\label{eq:fourier-L-step}
\gls{frrvar} = i \gls{frrstp} \ \text{with} \ i \in \gls{setN}^*_+
\end{equation}

\begin{equation}\label{eq:fourier-a3}
\gls{frrstp} = \frac{\gls{wavlen}}{4 \left( \sin \gls{brgang} - \sin \gls{brgang}_B \right)}
\end{equation}

\medskip

Assuming \( \gls{wavlen} = 0.154 \) nm (Cu) and \( \gls{celprm} =  0.4046 \) nm  (for Al FCC), we get the following table.

\medskip

{\renewcommand{\arraystretch}{1.6}

\input{insert/a3/a3}

\captionof{table}{Range of possible values for \gls{frrstp} as a function of (hkl).}

\bigskip

Here we will use hkl (200) and \gls{frrstp} will be set to \( 1.5 \) nm.

\subsubsection{Number of input files}

It can be observed that for a given \( \gls{frrstp} \sqrt{\gls{dst}} \), \( s \sqrt{\gls{dst}} \), \gls{roi} size and number of random points, the error of determination of the coefficients of the Fourier transform is the same from one file to another regardless of the density.
The question then arises as to what strategy to adopt to maintain consistency in the accuracy desired for each density.
We can distinguish two alternatives:
\begin{itemize}
\item Generate the same number of files (random draw) for each density.
\item Adapt the number of files to the density.
\end{itemize}
The first approach can be justified in the sense that the error after averaging the files will be comparable from one density to another.
However, it is conceivable that for low densities the coefficients found (although established with the same precision as for a high density) are less representative of the distribution model.
The calculation of the displacement field is done by summing the contribution of each dislocation.
With a large number of dislocations one can imagine that the displacement field is more likely to have converged to a representative value.
With a low number of dislocations the result would rather reflect the particularities of a specific random draw of dislocation positions.
This remark leads to the second approach.
This one consists in the fact that the number of total dislocations taken into account in the averaging is independent of the density.
For example if we divide the density by two, we multiply by two the number of files used for the averaging.

\subsubsection{Number of random points}

Since the error of determination of the Fourier transform is the same from one density to another when \( \gls{frrstp} \sqrt{\gls{dst}} \), \( s \sqrt{\gls{dst}} \), \gls{roi} size and the number of random points are fixed, it seems appropriate to keep the number of random points constant for all densities, at least as long as the simulations are conducted with a constant ROI size.
To evaluate the number of points required, we will look at the asymptotic behavior of the Fourier transform.
(The Fourier transform should have a linear behavior in \gls{r2} representation. See \ref{sec:representation-2}.)

The impact of the number of points and the value of \gls{frrstp} should be dissociated.
Since the exploitable interval of \gls{frrvar} (with \gls{frrtrf} positive and without noise) is strongly determined by \( 1 / \sqrt{\gls{dst}} \) (see section \ref{sec:filters}) we will fix the value of \( \gls{frrvar} \sqrt{\gls{dst}} \) in order to obtain an equivalent number of values of the Fourier Transform \gls{frrtrf}.
This makes the perception and appreciation of the asymptotic behavior equal for each density.

\subsection{Program}

The second program allows the simulation of X-ray diffraction and Fourier analysis.
It was implemented with OpenCL in order to take advantage of the high capacity of parallelization of the calculations on a graphics card.

\subsubsection{Repository}

Useful information can be found on the project page: \github{lpa-xrd}

\subsubsection{Installation}

The program can be installed or updated with the following command:

\pipinstall{lpa-xrd}

\subsubsection{Output data}

For each simulation a file containing the coefficients \( \gls{frrcfa}(\gls{frrvar}) \) and \( \gls{frrcfb}(\gls{frrvar}) \) for each harmonic \gls{hmc} and Fourier variable \gls{frrvar} is produced.
The structure of these files is illustrated by the example file below.

\pyscript{insert/output}{output\_data.py}

\txtlst{insert/output/croped}{output\_data.dat}
